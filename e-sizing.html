<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OFORI Electricals — NEC Sizing Assistant</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- html2canvas + jsPDF for PDF export -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{ --ofori-blue: #0366d6; --ofori-blue-dark: #012a4a; }
    .sidebar {
      background: linear-gradient(135deg, var(--ofori-blue-dark) 0%, var(--ofori-blue) 100%);
      color: #e6f2ff;
    }
    /* Make sidebar text variants (red-*) more readable by overriding locally */
    .sidebar .text-red-50, .sidebar .text-red-100, .sidebar .text-red-200 {
      color: rgba(230,242,255,0.95) !important;
    }
    .tab-active {
      border-bottom: 3px solid var(--ofori-blue);
      color: var(--ofori-blue);
      font-weight: 700;
    }
    .result-card {
      transition: all 0.3s ease;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
          <div class="flex items-center">
            <i class="fas fa-bolt text-3xl mr-3" style="color:var(--ofori-blue)"></i>
            <div>
              <h1 class="text-2xl font-bold text-gray-900">OFORI E-sizing</h1>
              <p class="text-xs text-gray-500 -mt-1">
                NEC Sizing Assistant — Breakers • Fuses • Overloads • Conductors
              </p>
            </div>
          </div>
          <div class="mt-4 md:mt-0 flex gap-3 items-center">
            <button id="export-pdf-btn"
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 hover:bg-red-200 transition">
              <i class="fas fa-file-pdf mr-1"></i> Export PDF
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="flex-1 max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Sidebar -->
        <aside class="sidebar lg:w-1/3 p-6 rounded-xl text-white shadow-lg" id="sidebar">
          <h2 class="text-xl font-semibold mb-3 flex items-center">
            <i class="fas fa-sliders-h mr-2"></i> Input Parameters
          </h2>
          <div class="mb-3">
            <label class="block text-xs font-medium mb-1">Device Name / Tag</label>
            <input id="device-name" type="text" placeholder="e.g. Pump P-101, MCC-2A" 
                   class="w-full p-2 rounded text-gray-900 text-sm" />
            <p class="text-[10px] text-red-200 mt-1">Optional device name or tag to include in exports.</p>
          </div>
          <p class="mb-3 text-red-50 text-xs leading-snug">
            Enter your load details based on device nameplate and NEC FLC tables. This assistant estimates
            <span class="font-semibold">minimum conductor ampacity</span>,
            <span class="font-semibold">breaker / fuse rating</span>, and
            <span class="font-semibold">overload sizing</span>.
          </p>

          <!-- System type -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">System Type</label>
            <div class="flex rounded-md shadow-sm overflow-hidden">
              <button id="btn-single"
                      class="flex-1 py-2 px-3 bg-red-600 hover:bg-red-700 text-sm">
                <i class="fas fa-bolt mr-1"></i> Single-phase
              </button>
              <button id="btn-three"
                      class="flex-1 py-2 px-3 bg-red-800 hover:bg-red-900 text-sm">
                <i class="fas fa-bolt mr-1"></i> Three-phase
              </button>
            </div>
            <p class="text-xs text-red-200 mt-1">
              Single-phase for most homes; three-phase for MCCs, switchgear, large motors.
            </p>
          </div>

          <!-- Voltage with grouped presets -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">Nominal Voltage (V)</label>
            <select id="voltage"
                    class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500">
              <option data-phase="1" value="120">120 V</option>
              <option data-phase="1" value="230">230 V</option>
              <option data-phase="1" value="240">240 V</option>

              <option data-phase="3" value="208">208 V (3φ)</option>
              <option data-phase="3" value="277">277 V (L-N, 480Y/277)</option>
              <option data-phase="3" value="347">347 V (L-N, 600Y/347)</option>
              <option data-phase="3" value="400">400 V (IEC)</option>
              <option data-phase="3" value="415">415 V (IEC)</option>
              <option data-phase="3" value="460">460 V</option>
              <option data-phase="3" value="480" selected>480 V (3φ)</option>
              <option data-phase="3" value="600">600 V</option>

              <option data-phase="3" value="2400">2400 V</option>
              <option data-phase="3" value="4160">4160 V</option>
            </select>
            <p class="text-xs text-red-200 mt-1">
              Choose typical domestic (120/240) or industrial (208/480/600/4160) voltages.
            </p>
          </div>

          <!-- Application type -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">Application Type</label>
            <select id="app-type"
                    class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500">
      <option value="motor">Motor / MCC</option>
      <option value="generator">Generator</option>
              <option value="general">General Branch Circuit Load</option>
              <option value="feeder">Feeder / Panel / Switchboard</option>
              <option value="transformer">Transformer Secondary</option>
            </select>
          </div>

          <!-- Load Inputs -->
          <div id="load-inputs" class="space-y-3 mb-4"></div>

          <!-- Load nature -->
          <div class="mb-4 grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium mb-1">Continuous?</label>
              <select id="continuous"
                      class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500 text-sm">
                <option value="yes">Yes (≥3h)</option>
                <option value="no">No</option>
              </select>
              <p class="text-[10px] text-red-200 mt-1">
                Continuous loads run for 3 hours or more. choose Yes for sustained-duty equipment.
              </p>
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Design Margin</label>
              <select id="design-margin"
                      class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500 text-sm">
                <option value="1.0">None</option>
                <option value="1.1">+10%</option>
                <option value="1.25">+25%</option>
              </select>
              <p class="text-[10px] text-red-200 mt-1">
                Optional engineering buffer to allow future growth or uncertainty. larger margins may increase conductor/breaker sizes.
              </p>
            </div>
          </div>

          <!-- Conductor / environment -->
          <div class="mb-4">
            <label class="block text-sm font-medium mb-1">Conductor &amp; Environment</label>
            <div class="grid grid-cols-2 gap-3 mb-2">
              <div>
                <label class="block text-xs mb-1">Material</label>
                <select id="cond-material" class="w-full p-2 rounded text-gray-900 text-sm">
                  <option value="cu">Copper</option>
                  <option value="al">Aluminum</option>
                </select>
              </div>
              <div>
                <label class="block text-xs mb-1">Insulation Rating</label>
                <select id="insulation" class="w-full p-2 rounded text-gray-900 text-sm">
                  <option value="60">60°C</option>
                  <option value="75" selected>75°C</option>
                  <option value="90">90°C</option>
                </select>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs mb-1">Derating Factor
                  <span class="ml-1 align-middle" title="Manual derating factor (0.2–1.0). Leave blank to auto-calc from CCC, ambient, insulation.">
                    <i class="fas fa-info-circle text-red-100 text-sm"></i>
                  </span>
                </label>
                <input type="number" id="derate-factor" value=""
                       min="0.2" max="1" step="0.01"
                       class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
                <p class="text-[10px] text-red-200 mt-1">
                  Leave blank for auto-derating (recommended), or enter manual factor.
                </p>
              </div>
              <div>
                <label class="block text-xs mb-1">Fault Level (kA)
                  <span class="ml-1 align-middle" title="Available fault current (kA) at this location — used to check interrupting rating. Obtain from utility or study.">
                    <i class="fas fa-info-circle text-red-100 text-sm"></i>
                  </span>
                </label>
                <input type="number" id="fault-level" value="25"
                       min="5" step="1"
                       class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
                <p class="text-[10px] text-red-200 mt-1">
                  Used for interrupting rating check.
                </p>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <label class="block text-xs mb-1">Current-carrying conductors
                  <span class="ml-1 align-middle" title="Number of insulated conductors in the same raceway that carry current (hot conductors and continuous neutrals). Affects ampacity adjustment.">
                    <i class="fas fa-info-circle text-red-100 text-sm"></i>
                  </span>
                </label>
                <input type="number" id="cond-count" value="3"
                       min="1" step="1"
                       class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
                <p class="text-[10px] text-red-200 mt-1">
                  Number of CCCs in raceway for adjustment.
                </p>
              </div>
              <div>
                <label class="block text-xs mb-1">Ambient Temp (°C)
                  <span class="ml-1 align-middle" title="Ambient temperature at the conductor location (°C). Affects temperature correction in auto-derating.">
                    <i class="fas fa-info-circle text-red-100 text-sm"></i>
                  </span>
                </label>
                <input type="number" id="ambient-c" value="30"
                       min="-20" max="60" step="1"
                       class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
                <p class="text-[10px] text-red-200 mt-1">
                  Used to compute automatic temperature correction.
                </p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <button id="btn-calc"
                  class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center mb-3">
            <i class="fas fa-calculator mr-2"></i> Calculate NEC Sizing
          </button>

          <button id="btn-reset"
                  class="w-full bg-red-900 bg-opacity-20 hover:bg-red-900 hover:bg-opacity-30 text-red-50 text-sm py-2 rounded-lg border border-red-300/40 transition flex items-center justify-center">
            <i class="fas fa-rotate-left mr-2"></i> Reset Inputs
          </button>

          <p class="mt-4 text-[10px] text-red-100 leading-snug">
            This tool simplifies key NEC concepts for quick checks (motors, feeders, branch circuits).
            Always consult the latest NEC (e.g. Articles 210, 215, 220, 240, 250, 310, 430) and your AHJ for final design.
          </p>
        </aside>

        <!-- Results -->
        <section class="lg:w-2/3 bg-white rounded-xl shadow-lg overflow-hidden">
          <!-- Tabs -->
          <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 px-6">
              <button id="tab-summary"
                      class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                <i class="fas fa-list-ul mr-1"></i> Summary
              </button>
              <button id="tab-devices"
                      class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-bolt mr-1"></i> Protective Devices
              </button>
              <button id="tab-conductors"
                      class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-stream mr-1"></i> Conductors
              </button>
              <button id="tab-motor"
                      class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                <i class="fas fa-fan mr-1"></i> Motor Rules
              </button>
            </nav>
          </div>

          <!-- Error -->
          <div id="error-box" class="hidden bg-red-50 border-l-4 border-red-500 p-4 m-4">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fas fa-exclamation-circle text-red-500"></i>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800" id="error-msg"></h3>
              </div>
            </div>
          </div>

          <!-- Content -->
          <div class="p-6 space-y-6">
            <!-- Summary -->
            <div id="content-summary">
              <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-chart-bar text-red-500 mr-2"></i> Sizing Summary
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <p class="text-sm font-medium text-gray-500">
                    Load Current (I<sub>load</sub>)
                  </p>
                  <p id="sum-load-current"
                     class="text-2xl font-semibold text-gray-900 mt-1">0.00 A</p>
                  <p class="text-xs text-gray-500 mt-2">
                    Based on input HP / kW / kVA / FLC.
                  </p>
                </div>
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <p class="text-sm font-medium text-gray-500">Min Circuit Ampacity (MCA)</p>
                  <p id="sum-mca" class="text-2xl font-semibold text-gray-900 mt-1">0.00 A</p>
                  <p class="text-xs text-gray-500 mt-2">
                    Includes continuous &amp; design margin factors.
                  </p>
                </div>
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <p class="text-sm font-medium text-gray-500">Selected Breaker</p>
                  <p id="sum-breaker"
                     class="text-2xl font-semibold text-gray-900 mt-1">—</p>
                  <p class="text-xs text-gray-500 mt-2">
                    Nearest standard rating &amp; interrupting check.
                  </p>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <p class="text-sm font-medium text-gray-500">Selected Conductor</p>
                  <p id="sum-conductor" class="text-xl font-semibold text-gray-900 mt-1">—</p>
                  <p class="text-xs text-gray-500 mt-2">
                    Based on derated ampacity ≥ MCA. Copper/Aluminum &amp; insulation considered.
                  </p>
                </div>
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <p class="text-sm font-medium text-gray-500">Notes</p>
                  <ul id="sum-notes"
                      class="mt-2 text-xs text-gray-600 list-disc list-inside space-y-1">
                    <li>Run calculation to see NEC-based suggestions.</li>
                  </ul>
                </div>
              </div>

              <!-- Chart -->
              <div class="mt-6 bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                <h3 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                  <i class="fas fa-chart-column text-red-500 mr-2"></i>
                  Current &amp; Ampacity Comparison
                </h3>
                <div class="h-56">
                  <canvas id="summary-chart"></canvas>
                </div>
              </div>
            </div>

            <!-- Protective Devices -->
            <div id="content-devices" class="hidden">
              <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-bolt text-red-500 mr-2"></i>
                Breakers • Fuses • Overloads
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <h3 class="text-sm font-semibold text-gray-700 mb-2">Breaker / Fuse</h3>
                  <p class="text-xs text-gray-500 mb-1">
                    Branch-circuit short-circuit &amp; ground-fault protection.
                  </p>
                  <dl class="mt-2 text-sm text-gray-700 space-y-1">
                    <div class="flex justify-between">
                      <dt>Suggested Breaker:</dt>
                      <dd id="dev-breaker" class="font-semibold">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>Suggested Fuse:</dt>
                      <dd id="dev-fuse" class="font-semibold">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>Device Factor:</dt>
                      <dd id="dev-device-factor"
                          class="font-mono text-xs">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>Interrupting Check:</dt>
                      <dd id="dev-ic-rating"
                          class="font-mono text-xs">—</dd>
                    </div>
                  </dl>
                  <p class="mt-2 text-[11px] text-gray-500">
                    Motors often allow higher multiples of FLC for breakers/fuses than general loads.
                    Verify with NEC 430.52 &amp; 240 for your device type.
                  </p>
                </div>

                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <h3 class="text-sm font-semibold text-gray-700 mb-2">Overload Protection (Motors)</h3>
                  <p class="text-xs text-gray-500 mb-1">
                    Thermal overload or electronic overload relay.
                  </p>
                  <dl class="mt-2 text-sm text-gray-700 space-y-1">
                    <div class="flex justify-between">
                      <dt>Overload Setting:</dt>
                      <dd id="dev-ol-setting" class="font-semibold">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>OL Factor:</dt>
                      <dd id="dev-ol-factor" class="font-mono text-xs">—</dd>
                    </div>
                  </dl>
                  <p class="mt-2 text-[11px] text-gray-500">
                    For motors, overloads are typically set between 115–125% of FLC
                    depending on service factor and temperature rise (NEC 430.32).
                  </p>
                </div>
              </div>
            </div>

            <!-- Conductors -->
            <div id="content-conductors" class="hidden">
              <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-stream text-red-500 mr-2"></i> Conductor Selection
              </h2>

              <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Chosen Conductors</h3>
                <dl class="mt-2 text-sm text-gray-700 space-y-1">
                  <div class="flex justify-between">
                    <dt>Phase Conductor:</dt>
                    <dd id="cond-phase" class="font-semibold">—</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt>Neutral (if required):</dt>
                    <dd id="cond-neutral" class="font-semibold">
                      Match phase
                    </dd>
                  </div>
                  <div class="flex justify-between">
                    <dt>Equipment Grounding (approx.):</dt>
                    <dd id="cond-egc" class="font-semibold">—</dd>
                  </div>
                  <div class="flex justify-between">
                    <dt>Derated Ampacity:</dt>
                    <dd id="cond-derated-amp"
                        class="font-mono text-xs">—</dd>
                  </div>
                </dl>
                <p class="mt-2 text-[11px] text-gray-500">
                  Ampacities are approximate for 75°C copper/aluminum and common installation conditions.
                  Always confirm with NEC Article 310 and grounding tables in Article 250.
                </p>
              </div>

              <div>
                <button id="btn-download-csv"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                  <i class="fas fa-download mr-2"></i>
                  Export Sizing Snapshot (CSV)
                </button>
              </div>
            </div>

            <!-- Motor Rules -->
            <div id="content-motor" class="hidden">
              <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-fan text-red-500 mr-2"></i> Motor-Specific Summary
              </h2>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <h3 class="text-sm font-semibold text-gray-700 mb-2">Motor Current Basis</h3>
                  <dl class="mt-2 text-sm text-gray-700 space-y-1">
                    <div class="flex justify-between">
                      <dt>Motor FLC Used:</dt>
                      <dd id="motor-flc" class="font-semibold">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>Branch Conductor (≥125%):</dt>
                      <dd id="motor-conductor" class="font-semibold">—</dd>
                    </div>
                    <div class="flex justify-between">
                      <dt>SCGF Device (% of FLC):</dt>
                      <dd id="motor-sccr" class="font-mono text-xs">—</dd>
                    </div>
                  </dl>
                  <p class="mt-2 text-[11px] text-gray-500">
                    For motors, conductors are usually sized at 125% of FLC, while breakers/fuses may be
                    at higher multiples to allow for starting inrush (NEC 430.22, 430.52).
                  </p>
                </div>

                <div class="result-card bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                  <h3 class="text-sm font-semibold text-gray-700 mb-2">Quick Motor Notes</h3>
                  <ul id="motor-notes"
                      class="mt-2 text-xs text-gray-600 list-disc list-inside space-y-1">
                    <li>Use NEC tables (430.248 / 430.250) for FLC, not nameplate, when sizing protection.</li>
                    <li>Overload protection typically 115–125% of FLC per NEC 430.32.</li>
                    <li>Breaker / fuse sized by NEC 430.52 (e.g. 250% for inverse-time, 800% for instantaneous-trip).</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </section>
      </div>
    </main>

    <!-- Footer -->
    <footer class="mt-4 text-center text-xs text-gray-500 pb-8">
      <div>
        Built by Solomon Ofori Manu.
        <span class="font-semibold">OFORI E-sizing</span>™ — Smarter power, safer circuits.
      </div>
      <div class="mt-1">Always verify with the latest NEC and your local AHJ.</div>
    </footer>
  </div>

  <script>
    // ----------------- Data & Helpers -----------------

    // Standard breaker / fuse ratings (A)
    const STANDARD_BREAKERS = [
      15, 20, 25, 30, 35, 40, 45, 50, 60, 70,
      80, 90, 100, 110, 125, 150, 175, 200,
      225, 250, 300, 350, 400, 450, 500, 600
    ];

    // Approximate conductor ampacity table (75°C) – simplified, educational only
    const CONDUCTOR_TABLE = {
      cu: [
        { size: '14 AWG Cu', amp: 20 },
        { size: '12 AWG Cu', amp: 25 },
        { size: '10 AWG Cu', amp: 35 },
        { size: '8 AWG Cu',  amp: 50 },
        { size: '6 AWG Cu',  amp: 65 },
        { size: '4 AWG Cu',  amp: 85 },
        { size: '3 AWG Cu',  amp: 100 },
        { size: '2 AWG Cu',  amp: 115 },
        { size: '1 AWG Cu',  amp: 130 },
        { size: '1/0 AWG Cu', amp: 150 },
        { size: '2/0 AWG Cu', amp: 175 },
        { size: '3/0 AWG Cu', amp: 200 },
        { size: '4/0 AWG Cu', amp: 230 },
        { size: '250 kcmil Cu', amp: 255 },
        { size: '300 kcmil Cu', amp: 285 },
        { size: '350 kcmil Cu', amp: 310 },
        { size: '400 kcmil Cu', amp: 335 }
      ],
      al: [
        { size: '8 AWG Al', amp: 40 },
        { size: '6 AWG Al', amp: 50 },
        { size: '4 AWG Al', amp: 65 },
        { size: '2 AWG Al', amp: 90 },
        { size: '1/0 AWG Al', amp: 120 },
        { size: '2/0 AWG Al', amp: 135 },
        { size: '3/0 AWG Al', amp: 155 },
        { size: '4/0 AWG Al', amp: 180 },
        { size: '250 kcmil Al', amp: 205 },
        { size: '300 kcmil Al', amp: 230 },
        { size: '350 kcmil Al', amp: 250 },
        { size: '400 kcmil Al', amp: 270 }
      ]
    };

    // Very rough EGC suggestions (educational)
    const EGC_TABLE = [
      { maxBreaker: 60, egc: '10 AWG Cu or 8 AWG Al' },
      { maxBreaker: 100, egc: '8 AWG Cu or 6 AWG Al' },
      { maxBreaker: 200, egc: '6 AWG Cu or 4 AWG Al' },
      { maxBreaker: 400, egc: '3 AWG Cu or 1 AWG Al' },
      { maxBreaker: 600, egc: '1/0 AWG Cu or 3/0 AWG Al' }
    ];

    // Resistance per 1000 ft for common copper conductors (ohms per 1000 ft) - approximate values
    const RESISTANCE_PER_1000_CU = {
      '14 AWG Cu': 2.525,
      '12 AWG Cu': 1.588,
      '10 AWG Cu': 0.999,
      '8 AWG Cu': 0.6282,
      '6 AWG Cu': 0.3951,
      '4 AWG Cu': 0.2495,
      '3 AWG Cu': 0.1970,
      '2 AWG Cu': 0.1563,
      '1 AWG Cu': 0.1239,
      '1/0 AWG Cu': 0.0983,
      '2/0 AWG Cu': 0.0779,
      '3/0 AWG Cu': 0.0618,
      '4/0 AWG Cu': 0.0490,
      '250 kcmil Cu': 0.0400,
      '300 kcmil Cu': 0.0345,
      '350 kcmil Cu': 0.0315,
      '400 kcmil Cu': 0.0285
    };
    // Aluminum conductors have higher resistance; use a rough multiplier
    const AL_RES_FACTOR = 1.6;

    const getResistancePer1000 = (material, conductorSize) => {
      if (!conductorSize) return null;
      // try exact lookup
      if (material === 'cu') {
        if (RESISTANCE_PER_1000_CU[conductorSize]) return RESISTANCE_PER_1000_CU[conductorSize];
      } else {
        // try copper lookup then apply factor
        if (RESISTANCE_PER_1000_CU[conductorSize]) return RESISTANCE_PER_1000_CU[conductorSize] * AL_RES_FACTOR;
      }
      // try to match by leading token (e.g. '4 AWG')
      for (const key of Object.keys(RESISTANCE_PER_1000_CU)) {
        if (key.toLowerCase().startsWith(conductorSize.toLowerCase())) {
          return material === 'cu' ? RESISTANCE_PER_1000_CU[key] : RESISTANCE_PER_1000_CU[key] * AL_RES_FACTOR;
        }
      }
      return null;
    };

    // NEC-style FLC snippet (from your article, educational subset)
    // Structure: FLC_TABLE[phase][voltage][hp] = FLC amps
    const FLC_TABLE = {
      "1": {
        230: {
          0.5: 4.8,
          1: 8.0,
          1.5: 10.0,
          2: 12.0
        }
      },
      "3": {
        230: {
          3: 9.6,
          5: 15.2,
          7.5: 22.0,
          10: 28.0,
          15: 42.0
        },
        460: {
          20: 27.0,
          25: 34.0,
          30: 40.0,
          40: 52.0,
          50: 65.0,
          60: 77.0,
          75: 96.0,
          100: 124.0,
          125: 156.0,
          150: 180.0
        }
        ,
        480: {
          30: 48.0
        }
      }
    };

    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const show = el => el && el.classList && el.classList.remove('hidden');
    const hide = el => el && el.classList && el.classList.add('hidden');
    const setText = (id, txt) => {
      const el = document.getElementById(id);
      if (el) el.textContent = txt;
    };

    const showError = msg => {
      const box = document.getElementById('error-box');
      const m = document.getElementById('error-msg');
      if (m) m.textContent = msg;
      if (box) show(box);
      setTimeout(() => hide(box), 6000);
    };

    const pickBreaker = valA => {
      for (const b of STANDARD_BREAKERS) {
        if (b >= valA) return b;
      }
      return STANDARD_BREAKERS[STANDARD_BREAKERS.length - 1];
    };

    const pickEGC = breaker => {
      for (const e of EGC_TABLE) {
        if (breaker <= e.maxBreaker) return e.egc;
      }
      return 'Consult NEC 250.122 table';
    };

    const pickConductor = (material, requiredAmp, derateFactor) => {
      const table = CONDUCTOR_TABLE[material] || [];
      const factor = derateFactor > 0 ? derateFactor : 1;
      for (const row of table) {
        const derated = row.amp * factor;
        if (derated >= requiredAmp) {
          return { ...row, derated };
        }
      }
      if (!table.length) return null;
      const last = table[table.length - 1];
      return { ...last, derated: last.amp * factor };
    };

    // Auto-derating: crude but intuitive model
    const computeDerateAutomatic = ({ conductorCount = 3, ambientC = 30, insulation = 75 }) => {
      let ccFactor = 1.0;
      if (conductorCount <= 3) ccFactor = 1.0;
      else if (conductorCount <= 6) ccFactor = 0.8;
      else if (conductorCount <= 9) ccFactor = 0.7;
      else if (conductorCount <= 20) ccFactor = 0.6;
      else ccFactor = 0.5;

      let tempFactor = 1.0;
      if (ambientC <= 30) tempFactor = 1.0;
      else if (ambientC <= 40) tempFactor = 0.91;
      else if (ambientC <= 50) tempFactor = 0.82;
      else tempFactor = 0.71;

      let insFactor = 1.0;
      if (insulation === 60) insFactor = 0.9;
      else if (insulation === 75) insFactor = 1.0;
      else if (insulation === 90) insFactor = 1.05;

      const derate = clamp(ccFactor * tempFactor * insFactor, 0.2, 1.0);
      return { derate, ccFactor, tempFactor, insFactor };
    };

    // ----------------- Load Input Templates -----------------
    const loadTemplates = {
      motor: () => `
        <div class="space-y-3">
          <h3 class="text-sm font-semibold mb-1 flex items-center">
            <i class="fas fa-fan mr-2"></i> Motor Protection (NEC 430)
          </h3>

          <div>
       <label class="block text-sm font-medium mb-1">Motor Power (HP)</label>
       <input type="number" id="motor-hp" min="0" step="0.5"
         class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500" />
            <p class="text-[10px] text-red-200 mt-1">
              Used to look up FLC from NEC tables or estimate if table value is not available.
            </p>
          </div>

          <!-- Motor phases follow global System Type; value stored hidden for calculations. -->
          <input type="hidden" id="motor-phases" value="3" />
            <div>
              <label class="block text-xs mb-1">Motor Type</label>
              <select id="motor-type" class="w-full p-2 rounded text-gray-900 text-sm">
                <option value="squirrel">Induction (Squirrel Cage)</option>
                <option value="synchronous">Synchronous</option>
                <option value="wound">Wound Rotor</option>
                <option value="other">Other / Special</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1">Use NEC Table FLC?</label>
              <select id="motor-use-table" class="w-full p-2 rounded text-gray-900 text-sm">
                <option value="yes" selected>Yes (Recommended)</option>
                <option value="no">No (use manual / estimated)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs mb-1">Motor FLC (A)</label>
              <input type="number" id="motor-flc-input" min="0" step="0.1"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500"
                     placeholder="From NEC table or nameplate" />
            </div>
          </div>

          <div>
            <label class="block text-xs mb-1">Breaker Type (NEC 430.52 multipliers)</label>
            <select id="motor-breaker-type"
                    class="w-full p-2 rounded text-gray-900 text-sm">
              <option value="inverse" selected>Inverse Time (× 250%)</option>
              <option value="inst-trip">Instantaneous Trip (× 800%)</option>
              <option value="time-delay-fuse">Time-delay Fuse</option>
              <option value="nontime-fuse">Non–Time-delay Fuse</option>
            </select>
          </div>

          <div>
            <label class="block text-xs mb-1">Service Factor (for overload setting)</label>
            <select id="motor-sf"
                    class="w-full p-2 rounded text-gray-900 text-sm">
              <option value="1.0">1.0</option>
              <option value="1.15" selected>≥ 1.15</option>
              <option value="1.25">≥ 1.25</option>
            </select>
            <p class="text-[10px] text-red-200 mt-1">
              SF ≥1.15 typically allows OL ≈115% of FLC, otherwise ≈125% (NEC 430.32).
            </p>
          </div>

          
        </div>
      `,
      general: () => `
        <div class="space-y-3">
          <h3 class="text-sm font-semibold mb-1 flex items-center">
            <i class="fas fa-plug mr-2"></i> General Branch Circuit
          </h3>
          <div>
            <label class="block text-sm font-medium mb-1">Load Current (A)</label>
            <input type="number" id="gen-current" min="0" step="0.1"
                   class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500"
                   placeholder="Branch load current" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1">Alternative: Load kW</label>
              <input type="number" id="gen-kw" min="0" step="0.1"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
            </div>
            <div>
              <label class="block text-xs mb-1">Power Factor</label>
              <input type="number" id="gen-pf" min="0.1" max="1" step="0.01" value="0.95"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
            </div>
          </div>
        </div>
      `,
      feeder: () => `
        <div class="space-y-3">
          <h3 class="text-sm font-semibold mb-1 flex items-center">
            <i class="fas fa-sitemap mr-2"></i> Feeder / Panel / Switchboard
          </h3>

          <div>
            <label class="block text-sm font-medium mb-1">Feeder Load (A)</label>
            <input type="number" id="feeder-current" min="0" step="0.1"
                   class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500"
                   placeholder="Calculated panel / feeder load" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1">Demand Factor</label>
              <input type="number" id="feeder-demand" min="0.1" max="1" step="0.05" value="1.0"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
            </div>
            <div>
              <label class="block text-xs mb-1">Spare Capacity</label>
              <input type="number" id="feeder-spare" min="0" max="0.5" step="0.05" value="0.25"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
              <p class="text-[10px] text-red-200 mt-1">
                Extra capacity fraction (e.g. 0.25 = +25%).
              </p>
            </div>
          </div>
        </div>
      `,
      generator: () => `
        <div class="space-y-3">
          <h3 class="text-sm font-semibold mb-1 flex items-center">
            <i class="fas fa-bolt mr-2"></i> Generator Sizing
          </h3>

          <div>
            <label class="block text-sm font-medium mb-1">Generator kVA (secondary)</label>
            <input type="number" id="generator-kva" min="0" step="0.1"
                   class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500"
                   placeholder="Installed generator kVA" />
            <p class="text-[10px] text-red-200 mt-1">Enter generator nameplate kVA or the kVA you intend to specify. Used to compute load current and percent loading.</p>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1">Power Factor</label>
              <input type="number" id="generator-pf" min="0.1" max="1" step="0.01" value="0.8"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500" />
              <p class="text-[10px] text-red-200 mt-1">Typical generator PF (default 0.8). Used when converting kW ↔ kVA.</p>
            </div>
            <div>
              <label class="block text-xs mb-1">Generator Type</label>
              <select id="generator-type" class="w-full p-2 rounded text-gray-900 text-sm">
                <option value="standby" selected>Standby / Emergency</option>
                <option value="prime">Prime</option>
                <option value="continuous">Continuous</option>
              </select>
              <p class="text-[10px] text-red-200 mt-1">Standby: short-term emergency power; Prime/Continuous used for sustained loading.</p>
            </div>
          </div>

          <div>
            <label class="block text-xs mb-1">Optional: Expected Load kW</label>
            <input type="number" id="generator-kw" min="0" step="0.1"
                   class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500"
                   placeholder="Enter if you prefer to input kW instead of kVA" />
            <p class="text-[10px] text-red-200 mt-1">If kW is entered, kVA will be derived using the power factor above.</p>
          </div>
        </div>
      `,
      transformer: () => `
        <div class="space-y-3">
          <h3 class="text-sm font-semibold mb-1 flex items-center">
            <i class="fas fa-microchip mr-2"></i> Transformer Secondary
          </h3>

          <div>
            <label class="block text-sm font-medium mb-1">Transformer kVA (secondary)</label>
            <input type="number" id="xfmr-kva" min="0" step="0.5"
                   class="w-full p-2 rounded text-gray-900 focus:ring-2 focus:ring-red-500" />
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs mb-1">Secondary Voltage (V)</label>
              <input type="number" id="xfmr-voltage" min="120" step="10"
                     class="w-full p-2 rounded text-gray-900 text-sm focus:ring-2 focus:ring-red-500"
                     placeholder="Blank = use global voltage" />
            </div>
            <div>
              <label class="block text-xs mb-1">Transformer Type</label>
              <select id="xfmr-type"
                      class="w-full p-2 rounded text-gray-900 text-sm">
                <option value="dry">Dry-type</option>
                <option value="oil">Oil-filled</option>
              </select>
            </div>
          </div>
        </div>
      `
    };

    const refreshLoadInputs = () => {
      const appType = document.getElementById('app-type').value;
      const div = document.getElementById('load-inputs');
      div.innerHTML = loadTemplates[appType]();
      // If motor template is injected, attach handlers to keep motor phases in sync
      try { attachMotorPhaseHandlers(); attachMotorHPHandlers(); } catch (e) { /* ignore if not present */ }
    };

    // Update voltage options visibility based on system type (single vs three)
    const updateVoltageOptions = (systemType) => {
      const sel = document.getElementById('voltage');
      if (!sel) return;
      let firstVisible = null;
      for (const opt of Array.from(sel.options)) {
        const p = opt.getAttribute('data-phase');
        if (!p) {
          // if no data-phase, show by default
          opt.hidden = false;
          if (!firstVisible) firstVisible = opt;
          continue;
        }
        if (systemType === 'single') {
          opt.hidden = p !== '1';
        } else {
          // show three-phase options
          opt.hidden = p !== '3';
        }
        if (!opt.hidden && !firstVisible) firstVisible = opt;
      }
      // if current selection hidden, pick first visible
      if (sel.selectedIndex < 0 || sel.options[sel.selectedIndex].hidden) {
        if (firstVisible) sel.value = firstVisible.value;
      }
    };

    const attachMotorPhaseHandlers = () => {
      // Keep the hidden #motor-phases value in sync with the global System Type.
      const msel = document.getElementById('motor-phases');
      if (!msel) return;
      msel.value = (window._systemType === 'three') ? '3' : '1';
    };

    // ----------------- Core Calculations -----------------

    // Top-level helper: approximate FLC from HP (used for auto-fill and fallback)
    const approxFromHP = (hpVal, V, motorPhases) => {
      const pf = 0.8;
      const eff = 0.9;
      const P_W = hpVal * 746;
      if (motorPhases === 3) {
        return P_W / (Math.sqrt(3) * V * pf * eff);
      } else {
        return P_W / (V * pf * eff);
      }
    };

    // Top-level helper: try to return FLC from the embedded NEC-like table
    const tryTableFLC = (hp, V, motorPhases) => {
      const phaseKey = String(motorPhases);
      const voltKey = Math.round(V);
      const tablePhase = FLC_TABLE[phaseKey];
      // reset voltage-approx flag
      window._motorTableVoltageApprox = false;
      if (!tablePhase) return null;

      // Direct voltage table match first
      let tableVolt = tablePhase[voltKey];
      let usedVoltKey = voltKey;

      // If we don't have an exact match for the selected nominal voltage,
      // try to find the nearest available voltage key in the table (e.g. 480 -> 460).
      if (!tableVolt) {
        const availVoltKeys = Object.keys(tablePhase).map(k => parseFloat(k)).filter(n => !isNaN(n));
        if (availVoltKeys.length) {
          let nearest = null;
          let nDiff = Infinity;
          for (const vk of availVoltKeys) {
            const d = Math.abs(vk - voltKey);
            if (d < nDiff) {
              nDiff = d;
              nearest = vk;
            }
          }
          const tolerance = Math.max(voltKey * 0.05, 50);
          if (nearest !== null && Math.abs(nearest - voltKey) <= tolerance) {
            tableVolt = tablePhase[nearest];
            usedVoltKey = nearest;
            window._motorTableVoltageApprox = true;
          }
        }
      }

      if (!tableVolt) return null;

      // HP in table is exact; try direct match first
      if (hp in tableVolt) {
        window._motorTableUsedVoltage = usedVoltKey;
        return tableVolt[hp];
      }
      // Try to match to nearest HP key if very close (e.g. 29.9 -> 30)
      const hps = Object.keys(tableVolt).map(parseFloat).sort((a, b) => a - b);
      let best = null;
      let bestDiff = Infinity;
      for (const h of hps) {
        const d = Math.abs(h - hp);
        if (d < bestDiff) {
          bestDiff = d;
          best = h;
        }
      }
      if (best !== null && bestDiff <= 0.25) {
        window._motorTableUsedVoltage = usedVoltKey;
        return tableVolt[best];
      }
      return null;
    };

    // Attach HP input handlers to auto-fill Motor FLC when possible
    const attachMotorHPHandlers = () => {
      const hpEl = document.getElementById('motor-hp');
      const flcEl = document.getElementById('motor-flc-input');
      const useTableEl = document.getElementById('motor-use-table');
      const voltEl = document.getElementById('voltage');
      const mPhEl = document.getElementById('motor-phases');
      if (!hpEl || !flcEl) return;
      // avoid duplicate bindings for the same element instance
      if (hpEl.dataset.autofill === '1') return;
      hpEl.dataset.autofill = '1';

      const onChange = () => {
        const hp = parseFloat(hpEl.value) || 0;
        if (!hp) {
          flcEl.value = '';
          return;
        }
        const V = parseFloat(voltEl?.value) || 480;
        const motorPhases = parseInt(mPhEl?.value || '3', 10);
        const useTable = useTableEl?.value === 'yes';
        let flc = null;
        if (useTable) {
          flc = tryTableFLC(hp, V, motorPhases);
          window._motorFromTable = !!flc;
        }
        if (!flc) {
          flc = approxFromHP(hp, V, motorPhases);
          window._motorFromTable = false;
        }
        if (typeof flc === 'number') flcEl.value = flc.toFixed(2);
      };

      hpEl.addEventListener('input', onChange);
      useTableEl && useTableEl.addEventListener('change', onChange);
      voltEl && voltEl.addEventListener('change', onChange);
    };
    const calculateLoadCurrent = () => {
      const systemType = window._systemType || 'single';
      const V = parseFloat(document.getElementById('voltage').value) || 480;
      const appType = document.getElementById('app-type').value;

      let Iload = 0;
      let motorFLCUsed = null;
      let motorFromTable = false;

      if (appType === 'motor') {
        const hp = parseFloat(document.getElementById('motor-hp')?.value) || 0;
        const flcInput = parseFloat(document.getElementById('motor-flc-input')?.value) || 0;
        const useTable = document.getElementById('motor-use-table')?.value === 'yes';
        const motorPhases = parseInt(document.getElementById('motor-phases')?.value || '3', 10);

        const approxFromHP = (hpVal) => {
          const pf = 0.8;
          const eff = 0.9;
          const P_W = hpVal * 746;
          if (motorPhases === 3) {
            return P_W / (Math.sqrt(3) * V * pf * eff);
          } else {
            return P_W / (V * pf * eff);
          }
        };

        const tryTableFLC = () => {
          const phaseKey = String(motorPhases);
          const voltKey = Math.round(V);
          const tablePhase = FLC_TABLE[phaseKey];
          // reset voltage-approx flag
          window._motorTableVoltageApprox = false;
          if (!tablePhase) return null;

          // Direct voltage table match first
          let tableVolt = tablePhase[voltKey];
          let usedVoltKey = voltKey;

          // If we don't have an exact match for the selected nominal voltage,
          // try to find the nearest available voltage key in the table (e.g. 480 -> 460).
          if (!tableVolt) {
            const availVoltKeys = Object.keys(tablePhase).map(k => parseFloat(k)).filter(n => !isNaN(n));
            if (availVoltKeys.length) {
              // find nearest voltage key
              let nearest = null;
              let nDiff = Infinity;
              for (const vk of availVoltKeys) {
                const d = Math.abs(vk - voltKey);
                if (d < nDiff) {
                  nDiff = d;
                  nearest = vk;
                }
              }
              // Accept nearest if reasonably close (within 5% or 50 V whichever larger)
              const tolerance = Math.max(voltKey * 0.05, 50);
              if (nearest !== null && Math.abs(nearest - voltKey) <= tolerance) {
                tableVolt = tablePhase[nearest];
                usedVoltKey = nearest;
                window._motorTableVoltageApprox = true;
              }
            }
          }

          if (!tableVolt) return null;

          // HP in table is exact; we try direct match first
          if (hp in tableVolt) {
            window._motorTableUsedVoltage = usedVoltKey;
            return tableVolt[hp];
          }
          // Try to match to nearest HP key if very close (e.g. 29.9 -> 30)
          const hps = Object.keys(tableVolt).map(parseFloat).sort((a, b) => a - b);
          let best = null;
          let bestDiff = Infinity;
          for (const h of hps) {
            const d = Math.abs(h - hp);
            if (d < bestDiff) {
              bestDiff = d;
              best = h;
            }
          }
          if (best !== null && bestDiff <= 0.25) {
            window._motorTableUsedVoltage = usedVoltKey;
            return tableVolt[best];
          }
          return null;
        };

        if (useTable) {
          let flc = tryTableFLC();
          if (flc) {
            motorFromTable = true;
          } else if (flcInput > 0) {
            flc = flcInput;
          } else if (hp > 0) {
            flc = approxFromHP(hp);
          } else {
            throw new Error('For motor: provide HP and/or FLC to determine load current.');
          }
          Iload = flc;
          motorFLCUsed = flc;
        } else {
          if (flcInput > 0) {
            Iload = flcInput;
            motorFLCUsed = flcInput;
          } else if (hp > 0) {
            const approx = approxFromHP(hp);
            Iload = approx;
            motorFLCUsed = approx;
          } else {
            throw new Error('Enter motor FLC (A) or HP when not using NEC table.');
          }
        }

        // Attach flag so we can note it later
        window._motorFromTable = motorFromTable;
      }
      else if (appType === 'general') {
        const I = parseFloat(document.getElementById('gen-current')?.value) || 0;
        const kW = parseFloat(document.getElementById('gen-kw')?.value) || 0;
        const pf = clamp(parseFloat(document.getElementById('gen-pf')?.value) || 0.95, 0.1, 1);
        if (I > 0) {
          Iload = I;
        } else if (kW > 0) {
          if (systemType === 'three') {
            Iload = (kW * 1000) / (Math.sqrt(3) * V * pf);
          } else {
            Iload = (kW * 1000) / (V * pf);
          }
        } else {
          throw new Error('Provide load current or kW for general load.');
        }
      }
      else if (appType === 'feeder') {
        const I = parseFloat(document.getElementById('feeder-current')?.value) || 0;
        if (!I) throw new Error('Enter feeder load in amps.');
        const demand = clamp(parseFloat(document.getElementById('feeder-demand')?.value) || 1.0, 0.1, 1.0);
        const spare = clamp(parseFloat(document.getElementById('feeder-spare')?.value) || 0, 0, 0.5);
        Iload = I * demand * (1 + spare);
      }
      else if (appType === 'generator') {
        // Generator sizing: accept kVA or kW + PF
        const kvaInput = parseFloat(document.getElementById('generator-kva')?.value) || 0;
        const kwInput = parseFloat(document.getElementById('generator-kw')?.value) || 0;
        const pfInput = clamp(parseFloat(document.getElementById('generator-pf')?.value) || 0.8, 0.1, 1.0);
        const genType = document.getElementById('generator-type')?.value || 'standby';

        let kva = kvaInput;
        if (!kva && kwInput) {
          kva = Math.abs(kwInput) / (pfInput || 1.0);
        }
        if (!kva) throw new Error('Enter generator kVA (or kW) to compute generator load current.');

        if (systemType === 'three') {
          Iload = (kva * 1000) / (Math.sqrt(3) * V);
        } else {
          Iload = (kva * 1000) / V;
        }

        // Attach generator_meta for later use
        window._generatorMeta = { kva, pf: pfInput, type: genType };
      }
      else if (appType === 'transformer') {
        const kva = parseFloat(document.getElementById('xfmr-kva')?.value) || 0;
        if (!kva) throw new Error('Enter transformer kVA.');
        let Vsec = parseFloat(document.getElementById('xfmr-voltage')?.value);
        if (!Vsec) Vsec = V;
        if (systemType === 'three') {
          Iload = (kva * 1000) / (Math.sqrt(3) * Vsec);
        } else {
          Iload = (kva * 1000) / Vsec;
        }
      }

      return { Iload, motorFLCUsed };
    };

    const applyMCAFactors = (Iload) => {
      const continuous = document.getElementById('continuous').value === 'yes';
      const margin = parseFloat(document.getElementById('design-margin').value) || 1.0;
      const contFactor = continuous ? 1.25 : 1.0;
      const MCA = Iload * contFactor * margin;
      return { MCA, contFactor, margin };
    };

    const sizeBreakerFuse = (appType, MCA, Iload, motorFLCUsed) => {
      let deviceFactor = 1.25;
      let olFactor = null;

      if (appType === 'motor') {
        const breakerType = document.getElementById('motor-breaker-type')?.value || 'inverse';

        if (breakerType === 'inverse') {
          deviceFactor = 2.5; // 250% inverse-time CB
        } else if (breakerType === 'inst-trip') {
          deviceFactor = 8.0; // 800% instantaneous-trip
        } else if (breakerType === 'time-delay-fuse') {
          deviceFactor = 3.0; // example value, time-delay fuse
        } else if (breakerType === 'nontime-fuse') {
          deviceFactor = 1.75; // example for non-time-delay fuse
        } else {
          deviceFactor = 2.0;
        }

        const sf = parseFloat(document.getElementById('motor-sf')?.value) || 1.0;
        olFactor = sf >= 1.15 ? 1.15 : 1.25;
      } else {
        deviceFactor = 1.25;
      }

      const baseCurrent = motorFLCUsed || Iload;
      const breakerSize = pickBreaker(baseCurrent * deviceFactor);
      const fuseSize = pickBreaker(baseCurrent * deviceFactor);
      return { breakerSize, fuseSize, deviceFactor, olFactor };
    };

    // Chart
    let summaryChartInstance = null;
    const buildSummaryChart = (Iload, MCA, deratedAmp, breakerSize) => {
      const ctx = document.getElementById('summary-chart');
      if (!ctx) return;
      if (summaryChartInstance) summaryChartInstance.destroy();

      const labels = ['Load', 'MCA', 'Derated Ampacity', 'Breaker'];
      const data = [
        Iload || 0,
        MCA || 0,
        deratedAmp || 0,
        breakerSize || 0
      ];

      summaryChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Amps',
            data,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.raw.toFixed(2)} A`
              }
            }
          }
        }
      });
    };

    // Build all results & populate UI
    const buildResults = () => {
      try {
        hide(document.getElementById('error-box'));

        const systemType = window._systemType || 'single';
        let material = document.getElementById('cond-material').value || 'cu';
        const derateRaw = document.getElementById('derate-factor').value;
        let derate = derateRaw !== '' ? clamp(parseFloat(derateRaw) || 1.0, 0.2, 1.0) : null;
        const appType = document.getElementById('app-type').value;
        const faultLevel = parseFloat(document.getElementById('fault-level').value) || 25;

        // If derate not provided, auto-compute
        if (derate === null) {
          const condCount = parseInt(document.getElementById('cond-count').value) || 3;
          const amb = parseFloat(document.getElementById('ambient-c').value) || 30;
          const insulation = parseInt(document.getElementById('insulation').value || '75', 10);
          const auto = computeDerateAutomatic({ conductorCount: condCount, ambientC: amb, insulation });
          derate = auto.derate;
        }

        const { Iload, motorFLCUsed } = calculateLoadCurrent();
        const { MCA, contFactor, margin } = applyMCAFactors(Iload);
        const { breakerSize, fuseSize, deviceFactor, olFactor } =
          sizeBreakerFuse(appType, MCA, Iload, motorFLCUsed);
        const conductor = pickConductor(material, MCA, derate);
        const egc = pickEGC(breakerSize);

        // Summary
        setText('sum-load-current', Iload.toFixed(2) + ' A');
        setText('sum-mca', MCA.toFixed(2) + ' A');
        setText('sum-breaker', breakerSize + ' A (est.)');

        if (conductor) {
          setText(
            'sum-conductor',
            `${conductor.size} @ ${conductor.amp} A (≈ ${conductor.derated.toFixed(1)} A derated)`
          );
          setText('cond-phase', conductor.size);
          setText('cond-derated-amp', conductor.derated.toFixed(1) + ' A (derated)');
        } else {
          setText('sum-conductor', 'No conductor found — increase size range.');
          setText('cond-phase', '—');
          setText('cond-derated-amp', '—');
        }

        setText('cond-neutral', 'Match phase unless neutral current is lower by design.');
        setText('cond-egc', egc);

        const notes = document.getElementById('sum-notes');
        if (notes) {
          notes.innerHTML = '';
          const mkLi = t => {
            const li = document.createElement('li');
            li.textContent = t;
            return li;
          };
          notes.appendChild(mkLi(`System type: ${systemType === 'three' ? 'Three-phase' : 'Single-phase'}.`));
          notes.appendChild(mkLi(`Continuous factor: ${contFactor.toFixed(2)}; design margin: ${margin.toFixed(2)}.`));
          notes.appendChild(mkLi(`Derating factor applied to ampacity: ${derate.toFixed(2)}.`));
          if (appType === 'motor') {
            if (window._motorFromTable) {
              if (window._motorTableVoltageApprox) {
                notes.appendChild(mkLi('Motor FLC taken from NEC FLC table (nearest-voltage match). Verify against full NEC 430.248/430.250 and nameplate.'));
              } else {
                notes.appendChild(mkLi('Motor FLC taken from NEC FLC table (snippet). Verify against full NEC 430.248/430.250.'));
              }
            } else {
              notes.appendChild(mkLi('Motor FLC estimated / user-entered. Always verify against NEC tables.'));
            }
            // Note about motor phases being driven by System Type (always shown for motor apps)
            notes.appendChild(mkLi('Motor phases follow the System Type (top control). Change System Type to set motor to single- or three-phase.'));
          }
          notes.appendChild(mkLi('Verify all results with NEC tables & manufacturer data before final design.'));
        }

        // Protective devices tab
        setText('dev-breaker', breakerSize + ' A (est.)');
        setText('dev-fuse', fuseSize + ' A (est.)');
        setText('dev-device-factor', (deviceFactor * 100).toFixed(0) + '% of FLC / load');

        const icStr = `Select breaker/fuse with interrupting rating ≥ ${faultLevel.toFixed(1)} kA at system voltage.`;
        setText('dev-ic-rating', icStr);

        if (olFactor && motorFLCUsed) {
          const olSetting = motorFLCUsed * olFactor;
          setText('dev-ol-setting', olSetting.toFixed(1) + ' A (est.)');
          setText('dev-ol-factor', (olFactor * 100).toFixed(0) + '% of FLC');
        } else {
          setText('dev-ol-setting', 'Not motor-specific / not used');
          setText('dev-ol-factor', '—');
        }

        // Motor tab
        if (motorFLCUsed) {
          setText('motor-flc', motorFLCUsed.toFixed(2) + ' A');
          setText(
            'motor-conductor',
            'Branch-circuit conductor ≥ 125% × FLC ≈ ' + (motorFLCUsed * 1.25).toFixed(1) + ' A'
          );
          setText(
            'motor-sccr',
            'SCGF device sized at ≈ ' + (deviceFactor * 100).toFixed(0) + '% of FLC.'
          );
        } else {
          setText('motor-flc', '—');
          setText('motor-conductor', 'Applicable for motor application type only.');
          setText('motor-sccr', '—');
        }

        // Motor notes appended
        const mnotes = document.getElementById('motor-notes');
        if (mnotes) {
          // base notes already in HTML; you can append dynamic ones if you want
        }

        // Chart
        buildSummaryChart(Iload, MCA, conductor ? conductor.derated : null, breakerSize);

        // Save for CSV
        window._lastSizing = {
          Iload,
          MCA,
          breakerSize,
          fuseSize,
          derate,
          material,
          appType,
          conductor,
          faultLevel,
          deviceFactor,
          olFactor,
          motorFLCUsed,
          // generator metadata if present
          generatorKVA: window._generatorMeta ? window._generatorMeta.kva : null,
          generatorType: window._generatorMeta ? window._generatorMeta.type : null,
          generatorPF: window._generatorMeta ? window._generatorMeta.pf : null,
          // extra metadata
          deviceName: document.getElementById('device-name')?.value || '',
          voltage: parseFloat(document.getElementById('voltage')?.value) || null,
          systemType: window._systemType || 'single',
          motorHP: parseFloat(document.getElementById('motor-hp')?.value) || null
        };

      } catch (err) {
        showError(err.message || 'Error during calculation.');
      }
    };

    // ----------------- CSV Export -----------------
    const exportCSV = () => {
      const s = window._lastSizing;
      if (!s) {
        showError('Run a calculation before exporting CSV.');
        return;
      }
      const rows = [
        ['Parameter', 'Value'],
        ['Device Name', s.deviceName || '—'],
        ['System Type', s.systemType === 'three' ? 'Three-phase' : 'Single-phase'],
        ['Voltage (V)', s.voltage || document.getElementById('voltage')?.value || '—'],
        ['Generator kVA', s.generatorKVA !== null ? s.generatorKVA : '—'],
        ['Generator Type', s.generatorType || '—'],
        ['Application Type', s.appType],
        ['Load Current (A)', s.Iload.toFixed(2)],
        ['MCA (A)', s.MCA.toFixed(2)],
        ['Breaker Size (A)', s.breakerSize],
        ['Fuse Size (A)', s.fuseSize],
        ['Motor FLC (A)', s.motorFLCUsed !== null ? s.motorFLCUsed.toFixed(2) : '—'],
        ['Motor HP', s.motorHP !== null ? s.motorHP : '—'],
        ['Conductor Material', s.material.toUpperCase()],
        ['Conductor Size', s.conductor ? s.conductor.size : '—'],
        ['Conductor Ampacity (approx)', s.conductor ? s.conductor.amp : '—'],
        ['Derated Ampacity', s.conductor ? s.conductor.derated.toFixed(2) : '—'],
        ['Derating Factor', s.derate.toFixed(2)],
        ['Device Factor', (s.deviceFactor * 100).toFixed(0) + '%'],
        ['Overload Factor', s.olFactor ? (s.olFactor * 100).toFixed(0) + '%' : '—'],
        ['Fault Level (kA)', s.faultLevel.toFixed(1)]
      ];
      const csv = rows
        .map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))
        .join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'OFORI_NEC_Sizing_Snapshot.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    };

    // ----------------- PDF Export -----------------
    // Export a clean, printable summary-only PDF by building a temporary
    // summary container, capturing it with html2canvas, and saving via jsPDF.
    const exportPdf = async () => {
      try {
        // Ensure summary tab is active and UI has updated
        try { activateTab('summary'); } catch (e) { /* ignore */ }
        await new Promise(r => setTimeout(r, 200));

        if (typeof html2canvas === 'undefined' || !window.jspdf) {
          return window.print();
        }

        // Require a recent sizing snapshot
        const s = window._lastSizing;
        if (!s) {
          showError('Run a calculation before exporting PDF.');
          return;
        }

        // Build an uncluttered summary HTML (inline styles to ensure consistent print look)
        const appType = s.appType || (document.getElementById('app-type')?.value || 'app');
        const now = new Date();
        const ts = now.toLocaleString();

        const notesList = [];
        const notesEl = document.getElementById('sum-notes');
        if (notesEl) {
          for (const li of Array.from(notesEl.querySelectorAll('li'))) notesList.push(li.textContent);
        }

        const conductorText = s.conductor ? `${s.conductor.size} @ ${s.conductor.amp} A` : '—';

        const html = `
          <div id="pdf-summary" style="font-family: Arial, Helvetica, sans-serif; color: #111; padding:20px; width:800px; background:#fff;">
            <div style="display:flex; align-items:center; justify-content:space-between;"> 
              <div>
                <h1 style="margin:0; font-size:20px; color:#b91c1c;">OFORI — NEC Sizing Summary</h1>
                <div style="font-size:12px; color:#444; margin-top:4px;">${appType.toUpperCase()} — Generated: ${ts}</div>
              </div>
              <div style="text-align:right; font-size:12px; color:#444;">${navigator.userAgent.split(')')[0]}</div>
            </div>
            <hr style="margin:12px 0; border:none; border-top:1px solid #eee;" />

            <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:8px;">
                <tr><td style="padding:6px 0; width:35%; color:#555">Device</td><td style="padding:6px 0; font-weight:700">${s.deviceName || '—'}</td></tr>
                <tr><td style="padding:6px 0; color:#555">System Type</td><td style="padding:6px 0; font-weight:700">${s.systemType === 'three' ? 'Three-phase' : 'Single-phase'}</td></tr>
                <tr><td style="padding:6px 0; color:#555">Voltage</td><td style="padding:6px 0; font-weight:700">${s.voltage || document.getElementById('voltage')?.value || '—'} V</td></tr>
                <tr><td style="padding:6px 0; color:#555">Motor HP</td><td style="padding:6px 0; font-weight:700">${s.motorHP !== null ? s.motorHP : '—'}</td></tr>
                <tr><td style="padding:6px 0; color:#555">Generator kVA</td><td style="padding:6px 0; font-weight:700">${s.generatorKVA !== null ? s.generatorKVA + ' kVA' : '—'}</td></tr>
                <tr><td style="padding:6px 0; color:#555">Generator Type</td><td style="padding:6px 0; font-weight:700">${s.generatorType ? (s.generatorType.charAt(0).toUpperCase() + s.generatorType.slice(1)) : '—'}</td></tr>
            </table>

            <table style="width:100%; border-collapse:collapse; font-size:13px;">
              <tr><td style="padding:6px 0; width:45%; color:#555">Load Current (A)</td><td style="padding:6px 0; font-weight:700">${s.Iload.toFixed(2)} A</td></tr>
              <tr><td style="padding:6px 0; color:#555">Min Circuit Ampacity (MCA)</td><td style="padding:6px 0; font-weight:700">${s.MCA.toFixed(2)} A</td></tr>
              <tr><td style="padding:6px 0; color:#555">Selected Breaker</td><td style="padding:6px 0; font-weight:700">${s.breakerSize} A</td></tr>
              <tr><td style="padding:6px 0; color:#555">Selected Conductor</td><td style="padding:6px 0; font-weight:700">${conductorText}</td></tr>
              <tr><td style="padding:6px 0; color:#555">Derating Factor</td><td style="padding:6px 0; font-weight:700">${s.derate.toFixed(2)}</td></tr>
            </table>

            <div style="margin-top:12px;">
              <h3 style="margin:0 0 6px 0; font-size:14px; color:#333">Notes</h3>
              <ul style="margin:0; padding-left:18px; color:#444; font-size:12px;">
                ${notesList.map(n => `<li>${n}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;

        // Append temporary container to body (offscreen) so tailwind doesn't interfere
        const wrapper = document.createElement('div');
        wrapper.style.position = 'fixed';
        wrapper.style.left = '-9999px';
        wrapper.innerHTML = html;
        document.body.appendChild(wrapper);

        // allow layout
        await new Promise(r => setTimeout(r, 120));

        const target = wrapper.querySelector('#pdf-summary');
        const canvas = await html2canvas(target, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
        try { pdf.setProperties({ title: 'OFORI NEC Sizing Summary' }); } catch (e) { /* ignore */ }

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth - 40, pdfHeight - 40);

        const fname = `OFORI_NEC_Summary_${appType}_${(new Date()).toISOString().replace(/[:.]/g,'-')}.pdf`;
        pdf.save(fname);

        // cleanup
        wrapper.remove();
      } catch (e) {
        console.warn('PDF export error, fallback to print', e);
        try { window.print(); } catch (err) { /* ignore */ }
      }
    };

    // ----------------- Tabs -----------------
    const activateTab = (name) => {
      const tabs = ['summary', 'devices', 'conductors', 'motor'];
      tabs.forEach(t => {
        const btn = document.getElementById('tab-' + t);
        const content = document.getElementById('content-' + t);
        if (t === name) {
          btn && btn.classList.add('tab-active');
          content && show(content);
        } else {
          btn && btn.classList.remove('tab-active');
          content && hide(content);
        }
      });
    };

    // ----------------- Init -----------------
    window.addEventListener('DOMContentLoaded', () => {
      // default system type and load inputs
      window._systemType = 'single';
      refreshLoadInputs();
      // ensure voltage options reflect initial system type
      updateVoltageOptions(window._systemType);

      // central setter that updates UI and state
      const setSystemType = (type) => {
        window._systemType = type;
        const a = document.getElementById('btn-single');
        const b = document.getElementById('btn-three');
        if (type === 'single') {
          a.classList.add('bg-red-600', 'hover:bg-red-700');
          a.classList.remove('bg-red-800', 'hover:bg-red-900');
          b.classList.add('bg-red-800', 'hover:bg-red-900');
          b.classList.remove('bg-red-600', 'hover:bg-red-700');
        } else {
          b.classList.add('bg-red-600', 'hover:bg-red-700');
          b.classList.remove('bg-red-800', 'hover:bg-red-900');
          a.classList.add('bg-red-800', 'hover:bg-red-900');
          a.classList.remove('bg-red-600', 'hover:bg-red-700');
        }
        updateVoltageOptions(type);
        // If motor template present and not overridden, update motor-phases
        try { attachMotorPhaseHandlers(); } catch (e) { }
      };

      // system type buttons
      document.getElementById('btn-single').addEventListener('click', () => setSystemType('single'));
      document.getElementById('btn-three').addEventListener('click', () => setSystemType('three'));

      // Power & PF header button intentionally removed per user request.

      // app type change
      document.getElementById('app-type').addEventListener('change', refreshLoadInputs);

      // calculate
      document.getElementById('btn-calc').addEventListener('click', buildResults);

      // reset
      document.getElementById('btn-reset').addEventListener('click', () => {
        document.getElementById('voltage').value = '480';
        document.getElementById('continuous').value = 'yes';
        document.getElementById('design-margin').value = '1.0';
        document.getElementById('cond-material').value = 'cu';
        document.getElementById('insulation').value = '75';
        document.getElementById('derate-factor').value = '';
        document.getElementById('fault-level').value = '25';
        document.getElementById('cond-count').value = '3';
        document.getElementById('ambient-c').value = '30';
        document.getElementById('app-type').value = 'motor';
        window._systemType = 'single';
        document.getElementById('btn-single').click();
        refreshLoadInputs();
      });

      // tabs
      document.getElementById('tab-summary').addEventListener('click', () => activateTab('summary'));
      document.getElementById('tab-devices').addEventListener('click', () => activateTab('devices'));
      document.getElementById('tab-conductors').addEventListener('click', () => activateTab('conductors'));
      document.getElementById('tab-motor').addEventListener('click', () => activateTab('motor'));

      // CSV & PDF
      document.getElementById('btn-download-csv').addEventListener('click', exportCSV);
      document.getElementById('export-pdf-btn').addEventListener('click', exportPdf);

      // default tab
      activateTab('summary');
    });
  </script>
</body>
</html>
